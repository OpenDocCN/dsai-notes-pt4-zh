# 人工智能—推荐系统公开课（七月在线出品） - P1：从零开始写代码：使用MovieLens的电影评分数据实践FM - 七月在线-julyedu - BV1Ry4y127CV

哦，我们开始了啊。嗯，今天从零开始呢。我们就从数据开始。我们从找手据开始啊。我明天找个数据集来。应能看到吧，我们去找一个。我能是手机。未蓝色手一机。找一个小点的。你知的。让后我们下载一下这个。

先看一下说明，下载的时候看一下说明。前面的没必要看，我们就看一下。他的。介绍。😊，大家大家大家看一下啊，因为我们要知道这个文件的结构才才好去写，就是写文件读取这一这一部分。

因为我们要做呃就写写就是需要快速的写一个简化版本，所以我们就不用到达所有的特征了。我们就只用它这个评分评分文件。然后看一下评分数据里面呢是这样一个结构。用户ID电影ID还有一个评分。然后是那个呃时间戳。

那我们知道哟。嗯，6000个用户，然后3000多个电影。然后呢，这个评分是在5分5分的范围，应该是1到5分。好吧。电影这个下载好了，你们来。这个嗯。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_1.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_2.png)

这是这是在哪个？

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_4.png)

嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_6.png)

嗯。哇，这个。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_8.png)

Oh。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_10.png)

行，就在这写吧。就在这个。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_12.png)

Yeah。我们来看一下这个我这个文件。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_14.png)

。嗯。哦等一下，我不知道这个字体小不小。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_16.png)

大家觉得这个字体小吗？

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_18.png)

小的话，我再调大一点。好，我们可我们继续啊。😊，啊，这个结构很简单，就是1个ID用ID，然后那个然后电影ID，然后还有一个评分。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_20.png)

然后现在我们来写一个函数，呃，不是开始写写代码。我们就写在一个文件里就可以了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_22.png)

就叫FM。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_24.png)

今系。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_26.png)

嗯，正好卡住卡在卡在范围内可以。嗯。好，我们先写一个读取文件的这样一个一个函数。我们尽量少的。就是尽量少。调用库。但是可能这个库必须得要。你们要要文件路径。我愿。不去。这个这个V我这个VI。

大家稍等一下啊。稍等一下。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_28.png)

我这个环境里面VI好像都没有都没有配置。颜色和换行都没有。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_30.png)

然后我们再去找一个。真的是从从零开始，我们环境呢都要配置一下。对啊。我们找一个模板找一个模板来。来配置一下。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_32.png)

嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_34.png)

，Okay。咦。😊。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_36.png)

嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_38.png)

哦，弄错了弄错了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_40.png)

So。嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_42.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_43.png)

。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_45.png)

啊，少了一个点儿。嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_47.png)

是点这个刚才两个两个名字打错了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_49.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_50.png)

这样应该好好了好了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_52.png)

我们继续啊。然后接下来就可以自动换行了。😊，然后我们要把我们的数据读取进来。呃，读取进来之后呢，我们要先想好我们用什么样的结构来存储它。呃，因为我们最终一个每一套训练数据的就是一个3元组。

所以我们直接用那个嗯用pathon list来存存储就好了。让我定一个。定一个list 。然后呢，我去读这个文件。从这个路径里面读文件。然后先把它切分了。先把前后的空格去掉。

因为我们看到那里面它是用两个冒号来分开来分割的。所以我们用两个冒号做分割服。这样完了之后呢，我们知道用户的ID是是第一项。嗯。把它转换int。然后呢。我没有爱吧。因为是ID。

然后那个电影的ID呢是第二项。对。哎，等一下，我先把那个。页面放在后面，我这有问题。大家可以看到嗯。然后评分是第三项。呃，评分虽然是它是1到5的呢，但是我们还是把它弄成一个浮点型。Oh。

然后把它添加到这个里面去。做成作为一个3元组。嗯。嗯，就可以了。嘢。试一下这个函数。什么情况？그。Yeah。Oh。然后我们打印前5项，看一下这个函数有没有问题。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_54.png)

当时writings。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_56.png)

嗯，大家看。数据读进来了，没有问题。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_58.png)

。然后接下来呢，我们定义我们这个的预测函数，也就是刚才FF呃。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_60.png)

FM模型里面的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_62.png)

这个函数。我们定一个函一个F函数来。做这个为了简单呢，我们看看把现现象。我们我们先把线性象跟这个呃就是这个常寿先先忽略掉。因为最关键的是这个二次项目。

我们先就是先主要的是就是在里面定义这个二次项就可以了。然后在定二次项之前呢，我们得把我们这个参数的数据结构给定义出来。因为这是两个矩阵嘛。就是用户和电影的那个影影特征矩阵。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_64.png)

然后我们先定义一下。举证。在这之前，我们先定义一下那个。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_66.png)

定义几个那个呃超参数。嗯。因为用户是大概多少个？少我一晚了吧。然后电影呢。而5000多个就6000吧。然后K呢。是我们这个引特征的维度。然后我们就订一场午。刚才有同学问这个K怎么选？

这个K是根据实际数据交叉验证出来的。这个没有人知道你的数据适合用多少。有的数据适合用高一点的，比如说用20，但有的数据可能用二就最好了。所以这个要根据情况来的。嗯，先定这两个就行了。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_68.png)

然后我们这个参数呢，因为要进行一些简单的向量运算，所以我们呃还是。不能直接用他的。这个是list。我们还是打入一个。MPY吧。我们用它里面的这个array来存储我们的参数。

然后用户的影像量嗯定义成这样子，就是M乘K嘛。然后我们用。Yeah。Yeah。因为它的ran函数来呃随机一个举证。MK。M行开裂。嗯。然后呢。V是电影的影特征矩阵。And。嗯，好，这样参数就有了。哼。

然后我们定一个函数。嗯，就定义成叫F吧。然后F呢。有两个参数。就是I和J。然后这个函数呢定义就是I用户I对电影界的评分。那他应该定义成什么样子呢？嗯，因为我没有新印象，其实很简单。就是他们两个。

这个I和J。对应的引特征做内机。对呢隐藏着做内机就可以了。如果在这里面写内机的话，嗯就要写成这个样子。要唉。嗯。啊，不。嗯。大家看这个没问题吧。对，K是超超参数是定义出来的。

然后如果你想确定你的K是多少的话，你是要做交叉验证，就是K取不同的值，然后做交叉验证K哪个好？代表是影特征的维度。我们就是把这个返馈值跟评作为预测评预测值的，就是评预测的评分。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_70.png)

你看我们的函数就这样定义的，因为我们是做评分预测，平分预测是一个回归问题。所以呢这个FX就就就等于X。我们前面不做变换了，所以说呢就是这个项。然后呢，同时呢，我们又把这个前面的项给忽略掉了。

就只剩二次项了。二次项了。又同时呢因为我们只有2个ID特征。只有用户的ID和电影的ID两个特征是非零的。所以呢这么多求和项也就退化成了一项。就是用户的引特征和电义的隐特征相做内机。

所以我们这里简化完简化完，就剩这么一个简单的式子了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_72.png)

就是两个两个箱子做内机。是。好，我们继续啊。Oh。嗯，为了明确起见呢，我们我我在这里把我们的损失函数写出来。损失函数。因为我刚才在PPT里面没有明确的写损失函数。因为嗯就是凡是回归问题。

它的损失函数其实都是都是就是那个呃。就军方损失函数嘛。所以它的损失函数呢就是预测值。Yes。减去。真实值。打电花。对吧。Yeah。그。呃，一般情况下呢，我们还会加一个就是一个正则项。嗯。下。啊。

还是还是不要改就这样。然后我们还要加一个正则项。政策下呢。我觉得写平方了，然后等可理解就行。Yeah。Yeah。然后前面加了加2分之1无所谓的。所以它是这样这样一个一个损失函数。

这这个损时函数大家有没有问题？就是一个平方损失，再加一个。平方损失再加一个正则项。所以我们要优化的就是这样一个目标。那我们要优化这样一个目标的时，目标化目目标呢我们就要对它求梯度。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_74.png)

嗯。求梯度这个事情，我们直接放在训练函数里面。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_76.png)

这里没有定义。这个。😊，reg是regulation是那个对叫可以叫惩罚系数，也可以叫那个政策化系数。这个先随便定一个值，这个值也是超参啊。这个值也是超参，这个值也是要交叉验证取出来的。呃。

不交叉验证选出来的。好吧嗯。就没问题了。好。有这个事在上面，我们就可以写我们的。训练。训练函数了。训练函数呢我们是直接导进一个数据集进去。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_78.png)

。直接导进一个数据集，然后我们去循环。I谢二。对。然后我们去去便历这样一个数据集。然后从里面取出3元组。你这个是什么那个又不会给我换好。不说紧，还先不办天继续吧。然后取出三元组之后，然后我们要做的事情。

就是。就是更新。You I。和VG要做的事情就是就是更新参数嘛。对吧。😊，那根新参数我们就要对上面求导数。最上面这个求导数在求导数之前呢，我们先因为导数里面第一项是预测嘛，P是等于FIJ。这个没问题吧。

因为预测值是用我们这个F函数定义出来的。P等于这个。啊，为了一致，我们这个不显示Y，这是R。二是真实评分。二是真实评分。然后这个P呢是预测曲。然后拿预测值减去真实值的平方，就是平方误差。对吧。

然后我们把这上面这这个整个式子，然后对UI求导对UI求导。看看同意什么。对于哀求岛呢，我们写成GI。GI前面这个平方向求环导之后呢，其实就是P。减去2。Yeah。我觉得求导过程我就直接写。

大家有问题可以直接问P减去2。因为P本身的定义是U和V的做内积。所以这个内机还就是内机还需要对这个UI做求导。内基对YUI做求导之后呢。它就等于VJ了。Yeah。这是前面前面一项的求导。然后呢。

212分之1我就去掉了，2分之1我就不没写了。然后后面这半项这个正则项的求导。就是。2分之1。啊，不不呃，没有2分之1，就是有这个。乘以。Your I。Yeah。这一行大家看看有没有问题。Yeah。

这行GI呢是这个损失函数对于UI的导数。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_80.png)

好，我们继续。然后。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_82.png)

相对应的把机械那个。也写出来，这前面都是一样的，完全对称的两是的。我我如果写错了，大家提醒我。Your爱。所以。Yeah。嗯。是。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_84.png)

Yeah。好，有了梯度之后，我们就要做梯度下降，梯度降就是。让这个电量。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_86.png)

U爱对，加一个空行。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_88.png)

在UI的基础上减去。7度减去梯度的时候呢，你要我要乘上一个步长。呃，一般是兰姆达一为兰姆达在那个。呃。🤢，在pason里面是关键词，我们就换一个吧。嗯嗯 step。所以最大。

然后所以我们要定一个再定一个超餐。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_90.png)

再定一个超声。这里我都是先随便写的啊，不一定是不一定有效的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_92.png)

先定一个小的补偿。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_94.png)

然后UI是这样更新。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_96.png)

然后。喂。谢。😊，这样更新。Oh。Yeah。然后就写完了。然后我们的训练函数就写完了。😊，大家发现有没有觉得太简单了。Yeah。然后这个函数运行一次呢，我们就迭代了迭代迭代完了一次。

就把这个数据就过一遍，然后更新一下就完事儿了。我们的主要部分已经写完了。现在我们为了看我们的成序效果呢，还需要写一个函数。因为我们需要看。我们的误差，所以我们写一个函数呢。家啊。什么停止？

因为他把这个数数据集过滤完一下，过滤完一遍停止了。Yeah。我写了一个函数叫MSE。MSEMS对我们要写1个IMSE函数，然后呢能够判断我的预测就是最后预测的误差是多少。好，能看到我的训练效果。

然后IMSE的话。嗯，需要两个参数。一个是数据集。还有一个我在这个。对啊，我们是单纯的气度下降。最单纯最单纯的梯度下降。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_98.png)

Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_100.png)

一个数据，然后还有一个预测的这这那个这个数据跟预测呢是一是每一行是对齐的，每一行是对齐的。明量对齐的，然后我们就可以算一下。嗯，需要有一个。需要有个求和的变量，还有一个技数的。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_102.png)

。Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_104.png)

因为我们要要要要对对这两个呃同时做访问，所以我们用下标来循环。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_106.png)

用下边来循环这个数据，然后呢有。等于啊不不写那个了。Yeah。这样我们换个变量。因为我们I和G要用到索引的，所以还是换一个。IJ和2。等于。That。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_108.png)

K。能取得DK个数据。然后呢，再取得。Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_110.png)

再取得DK个预测值。然后把它的平方加起来平方加起来就是P减去。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_112.png)

2。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_114.png)

的平方加起来嗯。然后再。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_116.png)

。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_118.png)

诶。😊。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_120.png)

加等于1，然后直接返返回。然后这个。最后这个求和的平和那个。Oh。然后那个开个开方。Okay。啊，这样我们有一个数据集和一个预测的话就可以。就可以算出它的RMSE了。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_122.png)

然后。只漏的。还需要一个什么函数呢？那我们还需要一个预算函数。这个预测函数是可以直接预预测的预测的那个值。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_124.png)

嗯。对，再写一个预测函数。Yeah。Yeah。然后给一个数据，然后我们预测。预测完了之后也是放到一个list里面。然后嗯定一个。等于这个。这种时不时的就不会缩进了。然后变利这个数据集，然后我们去做预测。

然后就是。FI键对吧？嗯。用FI键是预测值。Yeah。그。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_126.png)

嗯，应该有这几个函数就差不多了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_128.png)

嗯，我们我们还没有跑过，先先跑先测试一下这个。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_130.png)

诶唔讲晒啊。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_132.png)

哦。在下面。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_134.png)

行，我在最下面。把数据集。然后load进来之后呢，我们先测试一下我们那个函数。就是这个函数预测函数。Oh。做了2是吗？



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_136.png)

Yeah。Oh。我没看到啊，一会儿一会儿运行一下，看看看看吧。然后我们再打印一下。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_138.png)

。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_140.png)

Yeah。大家看下面一行就是预预测值，应该应该可以。这个时候的预测值呢没有经过任何训练，就是随机初始化之后的两个矩阵做内基算出来的。然后有了预的折后之后呢，我们就可以。看他的RMSE了。

然后我直接打印一下。打印一下。IE。看一下初始的IMSE是多少。Oh。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_142.png)

그。初始的IMC是4。36，大家看这个是很大的对吧？嗯因为因为总共那个就是呃就是1到5分嘛，它MS是4，所以还是很大的。待会我们会我们我们待会跑的时候会发现一些问题，我们我们自己要想一下该怎么调参数。

嗯。Yeah。因为我们是做随机梯度下降，所以我们的初始值呢要选在一个比较好的点上。因为FM它是一个非线性模型，所以我们只能找到它的局部最右键。它是有个二次二次模型。

我们是是是没办法找到它的那个全局自由解的，只能到局部自由解。所以我们的初始值一定要选好。大家看刚才我们还没有做训练的情况下，初始的这个东西就变成了4，这说明什么？说明我们的选的很不好，对吧？因为。

因为我们就做了一个继学模型的时候呢，我们通常会做一个最简单的baseline。这样我们可以大概知道我们的数据集就是最差最差不能差，不能比这个结果差。因为我的评分是1到5分，我的best line最简单。

我就做成1个2。5。😊，2。5最终算我就对所有的评分都预测成2。5。那我最终IMSE是不可是不可能很大的。因为它1到5分嘛，可能也就是2左右。所以说我初始出来一个4。就不行了，这这很不好。

那我问大家现在需要改哪里呢？竖始值没选好。那我们其实就要改初始值，对吧？在改什么地方，在第几行。😊，Yeah。对，UV的竖入值。我们刚开始呢是用这样一个，就是也是01的标标准的那个正态分布。

它是用标准正态分布去试始化。这个一般情况下呢，我们是。因为你想标准字段分布是有正有负的。然后他两个做内机之后呢。这个就是就是一个两个两个标准正正在正态分布出来的。现在他们做内机之后。

大概是大概的值多少呢？呃，我们改这个初始值的时候呢，有两种方法呃，有几有好几种方法。一个是呢我我把它变大，还有一个是把它变小。那我呢它我们应该是变大还是变小？Yeah。对，这位同同学说的很好，那是。嗯。

如果如果那那个两两个向量做内机的话。然后如果是他们最最他们的范围是从负一到正一的。所以呢我们这个肯定不是最优的这个，因为我们知道它是1到5之间，1到5之间。所以我们把把我们这个初始值呢。

大概的给它放到1到5之间去。对吧他不是均值是零吗？然我们给他。你啊。是1到5之间大概是4，然后乘4加上一。So。s。哎，不对，我我弄错了。嗯。Yeah。

我们如果要把它的那个就是就是随机的那个内机的范围弄到1到4的话，单项应该怎么写？Yeah。嗯。😊，嗯。Yeah。Oh。Oh。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_144.png)

大家觉得这个怎么样？

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_146.png)

Oh。嗯，这个比刚才好了一点，最开始4。36，然后是我刚才那个直接乘2之后，它变得更大了。🎼。因为这个跟我们的维度也有关系，因为我们维度是5。5吧。嗯。哦这个小了一点。是这样。

就是我们我们那个标准的标准的联域分布呢，它最终是-1到1。然后如果你给它如如果你给它整个向量乘上2的话呢，它的它最后做那做完内积之后就是-2到2-2到2了。嗯，那个。这位同学说。

用不用runN也用run。嗯，我们一般情况下都会用高斯分布去初始化我们的这样一个一个变量。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_148.png)

这是为什么呢？你注意看啊，因为我们在正则化的时候呢，适用的平方正则。嗯。当你用平方正则项的时候，其实你在假设你的参数是符合的是高斯分布。大家记住这一点，如果你是用平方证则。

你其实在假设你的参数符合这个呃这个高级分布。好吧，我们继续。因为因为我们没有加线性项跟那个呃跟那个常数项，所以全靠内机的话，这个东西是效果是不会特别好的。所以我们先不不管这个了，先做下面的。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_150.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_151.png)

然后我们开始寻开始。开始做训练。随便。🎼Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_153.png)

随便循环几次，然后做一个训练。上。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_155.png)

And。然后。然后再打印。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_157.png)

。Okay。啊，这个好慢。Yeah。Yeah。그。Yeah。🤧大家看出问题了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_159.png)

我们这个完全没有任何变化。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_161.png)

回去看一下问题出到哪儿了。Yeah。如果你的那个。就是这个这个程序运行完，它的意思是没有任何变化的话呢，你可以先改一下这个东西。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_163.png)

你把你的步长给大一点。嗯。嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_165.png)

Okay。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_167.png)

。不长改大一点，还没有作用的话，肯定是出问题了。我们来看看。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_169.png)

有喂。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_171.png)

你起来看看有没有是问题在哪儿。爱声。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_173.png)

哦，我我看看啊。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_175.png)

这个。Ui。😔，没没有，我们这个因为我们这个U和V是全局变量。然后。在这里的话，肯定是要肯定是对他做了修改的。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_177.png)

瞓下。叫i。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_179.png)

Yeah。呃，我们这个I键就是索引。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_181.png)

也就是用户ID和物品ID。啊，你说这个是吗？

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_183.png)

哦，这个不用加下表了。因为它是一个3元组，在这儿就直接把它解成解成一个3元组了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_185.png)

对，这儿这儿不用加下表，我看看数据。应该也没有问题。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_187.png)

Yeah。你说这个是吗？这里那个IJ就是下标啊。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_189.png)

I键就是优和V的下标。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_191.png)

UI把I直接当下标了。Yeah。Yeah。我们在这里打印一下。还有细。嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_193.png)

。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_195.png)

嗯，等一下，我看一下群里面的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_197.png)

那个data里面的IJ就是就是影店里面的IJ，这这个是一样的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_199.png)

所以所以这个是这里这里是没有问题的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_201.png)

然后看看。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_203.png)

食唉。这个梯度计算也没有错。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_205.png)

我系最会车。哦，我知道我我知道问你在哪儿了。😊，我太太大意了，我们这里训练完了之后，我们训练完了之后，根本就没有重新做预测。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_207.png)

大家看到了吗？嗯。我训练完了之后，根本没有重新做预测，就直接算RMSE了。所以他肯定是一样的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_209.png)

太晕了。我们家的这一行应该就不一样了，来看看效果。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_211.png)

呃，第二次就变小了很多。Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_213.png)

哎，多远几次看看。好像出现这种情况呢，我们程序呢就没有大问题了。但是呃我们做机器学习不是这个样子的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_215.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_216.png)

Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_218.png)

因为我们是需要训练集和测试级的。我们这里是呢只有一个数据集，在上面做训练，也在上面做预测。对吧。啊，我们刚才就。😊，嗯。Yeah。接下来呢我们就。把训练集和数据集给分开，然后看一下效果怎么样。

然后再分析一下问题。呃。Of us。我把倒数。总共有多少行？

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_220.png)

看看大概有多少号。这个。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_222.png)

。哦，好的好。我100万哈。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_224.png)

。这样我把我把最后20万行作为测试集，前面80万行呢作为训练集。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_226.png)

。然后训练级呢是。그。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_228.png)

付20万。Yeah。啊，不不。是从从头开始到付20万。然后测试集。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_230.png)

这集是后面的。这些不要了。は。然后呢，我们把测试集。和训练集分开预测。Yeah。그。然后打印的时候也是打印两个。就是我们做机器学习的问题的时候，呃，一定要把训练集和测试集的误差一起打印出来。

这样才好分析问题。Yeah。测设计。Yeah。我们把这个。嗯。😊。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_232.png)

复制复复制到前面来。就不用写那么次嗯。所以我每次在训练前呢打印一下。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_234.png)

Yeah。把最后一个删掉。嗯。啊，应该应该可以了吧，我们再跑一下。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_236.png)

。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_238.png)

哎，这次好像挺顺利的，训练训练集和测试集都都减小了，而且减小的不比较明显。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_240.png)

Yeah。Yeah。我们再多运几轮看看会出现什么情况，大家可以分析一下。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_242.png)

看起来是跑不动了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_244.png)

Yeah。一般情况下呢，如果我们的模型比较好的话，我们至少也可以让训练级。可以让训练级的呃那个。那个误差变得很小，因为我们这里的情况，大家看训练集和测试集之间的差距不是很大。

所以呢还没有出现过拟合的现象。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_246.png)

如果过拟滑的过拟合的话呢，我们待会可以调一下参数，让它出现过拟荷，看看是什么情况。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_248.png)

因为现在没有出现过拟盒，而纯粹的就是我训练级下不去。呃呃，但我不确定这个这个这个训练题还下不下得去，现在就是下不去的情况下。😊，嗯，大家觉得应该挑哪个参数，可以让训练机再下去一点。

就是你这时候可以先不管测试集。因为没有过拟合的现象，然后你就要想办法调参数，让。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_250.png)

对有同学说调K对吧？那K是调调大还是调小呢？如果如果单纯的想让训练级下去调可以调大还是调小。对我要把K调大一点。😊。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_252.png)

因为我要我要。让让训练级单纯的变小，其实就是我想象的过拟盒过拟盒，我要把电那个模型调的复杂一点。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_254.png)

就把它调大。看一下效果。大家看这是什么问题啊。😡，这应该是溢出了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_256.png)

一说的呢，一般情况下就是我的步长太大了。所以我。加个零看看。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_258.png)

嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_260.png)

哎，你看这一次。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_262.png)

一下子就比刚才最最好值接好了很多。刚才在1。1的时候就停住了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_264.png)

对吧。就次一下就变成1。021。03了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_266.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_267.png)

啊很想我。再抛几张看看。嗯。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_269.png)

大家注意这里有一个现象，就是那个如果我没弄错的话，我前一个是训练级的误差，后面一个是测试级的误差。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_271.png)

就是有时候测试级的误差可能会比训练级的会小一点，这个是正常的。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_273.png)

对，有了FM就是特征工程要做的东西就少了很多，你再也不需要手动做交叉了。你只要把原始特征处理好就完事了。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_275.png)

在原人当能处理好就完事了。如果预测效果好了，怎么使用预测好的模型？你你这个怎么使用是啥意思啊？你说你如果是说在线上怎么使用的话，那你这个模型我说的FM模型可以用在召回阶段，也可以用在排序阶段。

那最直接的就是用在排序阶段吧。那你预测出来评分，然后做排序就好了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_277.png)

好，这个太顺利了。我我觉得我们是我想把它。造出一个过拟合的效果。大家觉得我怎么样设置参数，能把它搞成过拟盒的。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_279.png)

嗯。对。数据我们就不变了，就还是用这个吧。这个数据集可能确实不容易过拟合，但是我们就是能观察到一些趋势就行了。这位同学说的很好，我不要正则向。对。我不要真能像。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_281.png)

看看效果。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_283.png)

如果大家有疑问，为什么不用智能相机能过拟盒的话。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_285.png)

然后可以提出来。有稍微多看几轮。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_287.png)

4。13差不多，这个数据看来真的不容易过离合。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_289.png)

对。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_291.png)

说明这个数据集就是质量太好了，这个是因为是mobilline挑出来的数据集，然后它的。这样我们如果想让他看到。Okay。你说的统计客征如果是是指那些次数吗？访问次数。有浏览次数关于次数的这些特征呢？嗯。

这个s这个事情呢，它影响的是收敛速度。然后呢，它跟过敏合。呃，不会不会不会说影响过你喝。但是我们先可以先看一下这个的效果。比如说我们把这个东西设的特别大。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_293.png)

设别大的话。它的效果就是跑偏了呀，压就跑过了，跑过头了，看看看看结果是多少。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_295.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_296.png)

你直接直接一出了。然后。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_298.png)

0。1。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_300.png)

嗯。Yeah。Yeah。Yeah。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_302.png)

Yeah。그。我怎我们怎么一下就选到了最优值呢？

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_304.png)

Yes。所以实验这个就不成功。你你如果是把它弄的特别小的话呢，这个效果大家也可以想到就是那个。我我刚才设0。1是不行的。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_306.png)

0。07。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_308.png)

P。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_310.png)

又失败了。好咩。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_312.png)

照这个样子，想到过你河就比较难了。嗯，真的就只能说把数据弄少一点，不过那个那个我们就不测试，我们再测试一个参数，我把这个K改成30。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_314.png)

看看会不会有过拟河的现象出现。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_316.png)

Okay。Yes。训练数据少是过拟合，石灰是容易过你合。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_318.png)

训练数数据少是容易过拟合。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_320.png)

而不是请你喝。你如果只有一个训练数据，那我预测的可准了，我可以预测误差为0。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_322.png)

对吧。没有用。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_324.png)

嗯，看来是不行了，这这个只能说这个数据级的。质量太高了。哎，你那个这位同学又说反了，模型复杂的时候是容易过你合。模些越复杂，越容易过你去。对对。模型越复杂，越容易过硬合。你想想那个例子。

我总共9个数据点，然后我用一个9次函数，我是可以精确的过每一个点的。但是我用一个一次函数呢，大家就可以拟合出一个差不多的直线。所以说你的模型复杂的话呢，是会过内合的。性别年龄那个。呃，不是。

FM是可以把所有特征放进去的。但是你要把所有的风同时放进去呢，我们实现的要要稍微复杂一点。😊，嗯，这里我们只是用到了用户ID和电影ID。所以呢其实它是等价于SVD的，就是所谓的最原始的SVD模型。

也就是我PPT里面那个。呃，就是那那个呃那那个链接上面那个那个模型最原始最原始做nextflix比赛，一直盘踞前几名的模型，就是我刚才写的这个。如果大家早生十年的话，十几年的话。

用这个模型说不定可以拿好多钱。嗯。好吧，那今天就先调到这儿吧，我们。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_326.png)

我待会儿把这个代码发给大家，然后呢，数据集我就发个链接给大家，自己去下载就可以了。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_328.png)

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_329.png)

你看我们这我们这里总共就这几个可以变的地方。😊，就是K，然后还有初始值，还有这个我们这个数据质量太好了，他对这些参数都不是很敏感。都能收收敛到比较好的那个部分。然后线性部分这个大家感觉就自己加吧。

因为它比这个因为加那个比这个要简单。就相当当于就给大家一个作业，大家自己加线性线性的部分，然后就看看效果怎么样。对。我们写的这个简单模型里面就没有什么可以调的了。



![](img/f009ba3df01ec62a4a8a0fa0f03876b0_331.png)

Yeah。嗯，最后这位同学讲这个呢嗯差不多是这个意思，但是其实不是SVD不需要年龄性别这些特征。是SVD，它加不了多的特征。他加不了别的特征。Yeah。分装裤，待会儿待会儿我那个现在就可以找。

等我说完这段话。😊，SVD是加不了其他的特征。就最开始出现SVD这个算法的时候，大家想的都是去那个分解平分矩阵。那我我还有好多数据用不上呢。用户的年龄性别，就你说的这些我很想用，但是我用不上。

很长一段时间内都没有人想通怎么去用。就是用户的其他特征，还有电影的标签特征，怎么样和SVD结合起来用。你知道吗？不是说。不是不需要用，是想用，不知道怎么用。就是我说的就是一层窗户纸。过了好多年。呃。

FM应该是哪一年？10年左右吧，10年左右。嗯，从006年到1也就45年时间。终于有终于有一个人就死的把这事想清楚了。然后提出了这样一个统一的FM模型。

要提出来你你如果从前面我说的从信息回归到二次回归去理解的话，其实是一个很自然的一个一个一个演化。但是就是大家都没想清楚这个事儿。在过在那个10年之前的56年之间，大家都致力于设计不同的矩阵分险模型。

比如说SVD加加这样的模型。然后写重复的代码，就没有人想清楚怎么样统一的。不管用户有多少特征，不管电影有多少特征，哎，我都加到我的矩分分解模型里面去。只有FM做到了。

另外这个同学总是执着于找FFM的封装库，我都我都说了，你去github找一堆。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_333.png)

그。你看你去找一下。嗯。各种语言的都有。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_335.png)

그。可以再去研究一下。拜拜。这他还不上。Yes。还有FFM的实现。Yeah。啊，有有有同学问到一个关键的问题，嗯，LFM就是引语音模型或者叫引引音子模型。LFM是一大类模型。就是银语模型有很多很多种。

然后FM只是其中一个。你比LFM就是一类算法。比如说我说聚类算法。那剧律上还有很多呀，那有开面，有高速混合，对吧？这些都是具体的分类算法。然后FMLF模型是是一类模型。

就说凡是你这个模型里面包含隐隐藏的这个就是引变量的，或者叫隐或者叫隐叫什么叫引因子吧，它都叫这个模型。sse里面的LFM其实就是FM嗯，我那我不是很确定啊，我我们可以去看一眼。Yeah。嗯。

ent套里面有SVD，还有啥？没没有没有你说的叫它称之为LFM的模型啊。没有吧。Yeah。所以你不要看他叫什么，你你你你在提LFM的时候，一定要去看他说的LFM是是表达什么意思啊。

比如说你你说矩阵分解模型，矩阵分解模型是一类模型。但是很多人拿它特指SVD啊。你看这里面有SVDSVD加，它都是矩证风险模型。但是有些文章里或者有些作者，他把他提到举证风险的时候，特指SVD。

然后像你说的这个英语模型，它在它的课程或者是它这个场景里面，它特指某一个，比如说就特指FM。是或者可以直接特制SVD。嗯。所以你要看它特指的是哪个东西，你直接拿出来说FFM的话是不确定的。

它是不确定指向某一个算法的。因为它是一大类算法。好吧。大家如果没问题的话呢，真的可以去自己实现一个。今天给大家演示这段代码，其实就是说这个很多机器学习的段代码其实就是挺短的，比你写了很多。

可能刷的let code要短。그。所以没事，自己多实现几个算法。好，如果没问题的话，今天就这样。然后本来是要给大家看一些那个就是呃。就是矩阵呃，不是不是呃，就是推荐系统的那个框架的。然后我们下次课吧。

下次课一起再过过几个那个推荐系统的事例。行，没问题。咱们今天就这样。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_337.png)

有问题线下找我。

![](img/f009ba3df01ec62a4a8a0fa0f03876b0_339.png)