# P23：1-模板匹配方法 - 迪哥的AI世界 - BV1hrUNYcENc

这节课呀咱们来说一下在open CV当中啊，怎么样进行模板匹配，我先大家解释一下。

![](img/036488676268557681777ffb9b8c9df0_1.png)

什么叫做咱们这个匹配的工作，在这里呢我先打开了两张图像，第一张图像就是LINA啊。

![](img/036488676268557681777ffb9b8c9df0_3.png)

他的一个脸让我截出来了，第二张图像呢就是LINA啊，他的这个整个的一张图片。

![](img/036488676268557681777ffb9b8c9df0_5.png)

那我们现在要做一件事，就是哎我左边拿到了一个模板，我现在想去看一下这张模板啊，它是在原始图像当中的哪一个部分，说白了就是我先有这个点，这个点啊，你说我在这里我可以画几个框，我这样我用个蓝色的吧。

在这一块我说画了几个框，我说第一个框是A，然后这个它是一个B，然后呢下面可能还有我说这个是个C，这是D这是E这是F，它的大小应该都是相同的，都是这个模板的大小，我现在就想去找一下ABCDEF当中啊。

哎哪一个跟我这个当前给出来的，LINA这张脸的模板最像啊，咱们要做这样一件事，所谓我们的模板匹配啊，估计大家现在猜出来了，那你说我们应该怎么去办啊，比如说在这里我说它啊它是一个三乘呃，这样我说这一块啊。

它是一个3×3的，这是一个3×3的图像，然后这一块它是一个9×9的图像，咱们简单的说我一个9×9的，我是不是能分成多块3×3的呀，那这里比如这里咱分成这么的吧，分就分成九大块吧，分类卷二当中。

我是不是要每一块每一块进行匹配啊，这个啊就是我们的一个模板匹配啊，他是怎么去做的，其实呢就是跟我们那种卷积的一步一步啊，进行黄窗过滤啊，是一样的，在这一块首先我拿到了一个模板窗口，拿到模板窗口之后。

我要从左到右从上到下啊，注意open CV当中啊，是这样的顺序，从左到右从上到下一点点的进行匹配，比如说我在第一个位置，我说这是第一个位置，定个位置去匹配一下当前模板A和图像当中的，我这一号区域。

它的一个就是匹配程度是有多大的，那这个匹配程度可以怎么计算啊，计算方法有挺多的，然后open CV当中要给出来我们几种，比如最简单的我们说啊这样一个区域当中，每一个点它不还是一个像素点吗。

你看我说这是这一个点，这一个点这一个点每个点还是像素点吧，那这是一个3×3大小的，我的模板是不是也是3×3大小的呀，我可不可以逐个像素点去比较什么，去比较它们像素点之间的差异。

比如这个点这第一个点是127，第二点是200，第三个点是100，随便截几个值吧，然后这里呢这里第一个点它是一个100，第二点是200，第三个点是二百五吧，反正随便三个数，我问你干什么。

可以算一下点和点之间差异吧，对应位置的那127的跟100的比，200的跟200的比，100的跟二百五的比，对应位置进行一个减法，如果说你要做一个平方向的，再进行一个平方向吧。

所以说我们现在就是给了个模板之后，我们拿波板要在原始图像当中一个区域，一个区域进行比照，比较什么呢，就看他们之间差异有多少的，这个就是我们的一个模板匹配啊，基本的方法，然后再给大家说一下。

就就是open CV当中啊，他给我们得到的结果是长什么样子匹配哎呀，按照咱们这个方法或窗口一步一步匹配，匹配完啊，他会给我返回一些结果，第一个结果就是他会告诉我，每一个位置匹配的结果吧。

你看这里我可以匹配多个窗口吧，在这一块它会返回的是每一个窗口匹配的结果，但是这个结果啊，可能由于你指定的一些匹配算法不同啊，它的结果差异是不一样的，比如说你看我刚才跟大家说的，我说啊有有这些方法。

我们按照一些平方向，平方向在比较过程当中越像的应该怎么样，越像的是不是它的一个平方向的一个就是相减，然后再平方向它的值应该越接近于零，代表它越相近啊，代表着每个像素点的值差距都比较小吧，这是平方向的。

应该越小越接近，有些时候呢它是相关系数吧，相关系数啊，用一些相关系数相关的去计算的时候，那就是等于一的时候越相近，等于零的时候越不相近吧，这里啊就一会我给大家展示啊，咱不同的几种方法。



![](img/036488676268557681777ffb9b8c9df0_7.png)

其实呢建议大家先看下这个这块，我给大家给出一个链接。

![](img/036488676268557681777ffb9b8c9df0_9.png)

在这个链接当中，我们可以先点进去看一下这个链接啊，就是open CV官网当中给出来的，几种不同的一个方式，你看他首先要告诉你啊，咱这个函数叫什么，template match是吧。

我们的一个模板匹配它的一个方法都有哪些，这里咱来简单看一下吧。

![](img/036488676268557681777ffb9b8c9df0_11.png)

第一个是什么，square difference是什么平方向吧。

![](img/036488676268557681777ffb9b8c9df0_13.png)

你看是用平方向去做的吧，然后呢下面还有一些相关系数，相关的这些公式啊。

![](img/036488676268557681777ffb9b8c9df0_15.png)

就不给大家一个去看了，到时候大家在看的时候简单过一下就行，其实无非就是用一些偏方向的来去当做它们，像素点之间的损失，或者用相关系数去计算啊。



![](img/036488676268557681777ffb9b8c9df0_17.png)

这个意思下面他会告给你解释啊，每一个输入的参数都是什么东西，然后呢我再跟大家说这样一个事儿，就是在咱们这里啊。



![](img/036488676268557681777ffb9b8c9df0_19.png)

我们要给大家看一下，是它的计算结果呃，首先这样我们先读进来一张图像。

![](img/036488676268557681777ffb9b8c9df0_21.png)

独建一张图像，就是LINA这张图像在这里就是这个图，这是LINA，LINA呢，我看了一下他imagine点shape管成灰度图啊，之后他是263263啊。



![](img/036488676268557681777ffb9b8c9df0_23.png)

这是它的大小，然后呢我选出一个模板，这个模板就是我这个CV two imagine reid。

![](img/036488676268557681777ffb9b8c9df0_25.png)

又把这个face读进来了，都是灰度图啊，读进来之后，然后这是他的一个脸。

![](img/036488676268557681777ffb9b8c9df0_27.png)

那接下来我看咱们来看一个事，我接下来啊做了这样一个动，就是做了一个模板匹配之后，我打印了什么，打印了它的一个大小，那咱们来对比一下，原始输入的DNA是263263的模板。

能给出来点的大小是110×85的，我返回出来的结果是什么，返回来结果是154，逗号179，这个数哪来的，代表什么意思啊。



![](img/036488676268557681777ffb9b8c9df0_29.png)

在这一块直接给大家写出来了，假设咱原图像的大小是A乘B，模板大小呢是小A乘B那输出就有矩阵，就是大A哎，对应位置H减HW减W，大A减小A加一，然后呢大B减小B再加一啊。



![](img/036488676268557681777ffb9b8c9df0_31.png)

这就是我表示的我最终啊结果的大小，这个结果表示的就是你现在啊就是在模板。

![](img/036488676268557681777ffb9b8c9df0_33.png)

比如在这里，你不是在一步一步进行匹配吗。

![](img/036488676268557681777ffb9b8c9df0_35.png)

匹配过程当中它对每一个位置啊，注意点它是匹配过程当中的每一个位置的结果。

![](img/036488676268557681777ffb9b8c9df0_37.png)

相当于每个窗口它的一个结果了。

![](img/036488676268557681777ffb9b8c9df0_39.png)

但是这个结果就像我刚才说的，你指定的一个方法不同，因为有些是小值越小的时候诶它越相近，有些时候呢是值哎越近于一的时候越相近。



![](img/036488676268557681777ffb9b8c9df0_41.png)

你根据啊你制不同指定的方法，你来去观察你的result当中啊，返回出来这些值诶，它的一个作用是长什么样子，在这里有一个我非常简单的方法。



![](img/036488676268557681777ffb9b8c9df0_43.png)

就是不用你啊自己一个去看了，因为这个result当中啊，你看点shift值，大家也看到里边的数是不是挺多的，因为我这个滑动窗口，那模板在原始图像当中一步步去滑，能划出来窗口简直太多了。



![](img/036488676268557681777ffb9b8c9df0_45.png)

自己去计算很麻烦，open CV当中呢给出这样一个函数，就这个叫做一个mean max location这个东西，然后你把它这个result。



![](img/036488676268557681777ffb9b8c9df0_47.png)

就你刚才算出完这个结果传进去，它会啊帮你返回出来这么四个值，我们分来分别来看一下，第一个最小值哎，最大值最小值坐标位置。



![](img/036488676268557681777ffb9b8c9df0_49.png)

最大值坐标位置，那这个有什么用啊，在这里先说第一个例子。

![](img/036488676268557681777ffb9b8c9df0_51.png)

在我们这个当中，我们来看一下我现在这一块进行了一个哦。

![](img/036488676268557681777ffb9b8c9df0_53.png)

看一下在哪哦，在这块进行了一个就是模板匹配嘛，匹配过程当中啊，传进来一个一这个一是这个意思啊。

![](img/036488676268557681777ffb9b8c9df0_55.png)

你不写一，你写出这个东西，就是这个CV two点square difference，你直接写它也行，咱这样我先把它改成这个东西吧，就是一个CV two点呃，Square difference。

然后执行一下，你看它的一个结果。

![](img/036488676268557681777ffb9b8c9df0_57.png)

哎咱们上面重新执行一下吧，要不然这个结果会变的像，因为我刚才又读了一些图像。

![](img/036488676268557681777ffb9b8c9df0_59.png)

咱重新跑一下行，还是1154179吧，在这里啊，他是这样，当我在执行过程当中啊，你看啊他诶在这块咱把下面执行出来吧。



![](img/036488676268557681777ffb9b8c9df0_61.png)

把下面几个最大最小值也执行出来。

![](img/036488676268557681777ffb9b8c9df0_63.png)

这里也就是它的几个值的一个结果，咱可以分别来看一下这里最小值，最大值，最小值位置，最大值位置，分别表示着你当前用这种方法去做的时候，给我得到的结果，那我问大家一个事。

你说当前我们用这个square difference去做的时候，我应该是选择大值好呢，还是选择小值好呢，比如说我想做这样一件事，我就找到哎哪块他是他的人脸，那个大值还是小值啊，对当前咱的方法来说。

应该是小值吧，为什么，因为越小的一个值，代表着它的一个像素点阵差异越小吧，所以说啊我们关注的点就是这个东西，Mean location。



![](img/036488676268557681777ffb9b8c9df0_65.png)

相当于我知道了最小值它所在的一个位置，最小值所在的位置就是这样。

![](img/036488676268557681777ffb9b8c9df0_67.png)

在这图能给大家画一下，比如这个图这个图当中它是在我看哦，大概画一下吧，大概是这样的一个位置哎，大概是这样一个位置吧，那最小值位置在哪啊，最小值位置就是左上角这个点。

它它这个密location就是左上角这个点，那你说你知道这个点了，他人脸框你能不能画出来，他第一个H你模板的一个长度宽度都知道吧，咱刚才是不是把模板读见了，我分别打印它shift值。

那你知道这个me location左上角这个点之后，H和W都有了，你能够把他这个人脸框给画出来吧，这个就跟大家说了一下啊。



![](img/036488676268557681777ffb9b8c9df0_69.png)

咱的一个就是模拟题算法当中啊，最基本的一步操作是怎么去做的。

![](img/036488676268557681777ffb9b8c9df0_71.png)

在这里呢再给大家捋一遍啊，首先我们先把图像读进来，在这里注意啊，我们要读建两张图像，一张图像是我当前的就是原始图像，那张图像是我的模板。



![](img/036488676268557681777ffb9b8c9df0_73.png)

我们的template，然后呢我第一步第一步进行啊，这前面都转成灰度图啊。

![](img/036488676268557681777ffb9b8c9df0_75.png)

第一步我进行一个模板的匹配，在匹配过程当中啊，指定原始输入是什么。

![](img/036488676268557681777ffb9b8c9df0_77.png)

模板是什么，以及呢当前你用哪种方法去做，在这里啊，我选择了其中一种啊，就是method当中一共是有六种的，下面还有一些归一化的一个结果，在这里啊，尽尽量建议大家用这些归一化的结果。

因为归一化结果相对来说更公平一些，这个样子大家有时候用的时候，就尽量用这些带归一化的。

![](img/036488676268557681777ffb9b8c9df0_79.png)

因为相当于加了归一化，得到结果更可靠一些这个意思，然后打印这不值。

![](img/036488676268557681777ffb9b8c9df0_81.png)

咱可以看，咱可以来算一下这154179吧，前面你看263算一下吧，263-1102，再加上一个一，是不是等于154啊，结果没问题吧，我看一下啊，结果没问题是吧，所以说这点啊我就得到了当前啊。



![](img/036488676268557681777ffb9b8c9df0_83.png)

我结果的一个大小，结果大小表示着哎，我这结果当中每一个窗口左上角点它的一个值，或者说代表这个窗口你得到的一个损失，如果说平方向。



![](img/036488676268557681777ffb9b8c9df0_85.png)

那就平方向损失得多少嘛，然后呢，接下来我用一个min max location去定位一下。

![](img/036488676268557681777ffb9b8c9df0_87.png)

定位什么呢，咱当前这个呃就当前这个方法当中，我要的是min location。

![](img/036488676268557681777ffb9b8c9df0_89.png)

有些不有些你用其他算法的时候，可能我们要换一下，这是我们的min location。

![](img/036488676268557681777ffb9b8c9df0_91.png)

灭LOGI的过程当中啊，传建最小值，最大值以及最小值的位置。

![](img/036488676268557681777ffb9b8c9df0_93.png)

那接下来我把最小值的位置给它指定出来，在这个位置上我去把它画出来，是不是，相当于我又得到了，我当前最好的一个匹配的结果了。



![](img/036488676268557681777ffb9b8c9df0_95.png)

这个就跟大家说了一下啊，咱们的一个模板匹配算法当中。

![](img/036488676268557681777ffb9b8c9df0_97.png)